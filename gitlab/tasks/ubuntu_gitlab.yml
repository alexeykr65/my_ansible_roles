---
# tasks file for gitlab
- name: GITLAB=>> Update cache all packages
  apt: 
    update_cache: yes 
    force_apt_get: yes 
    cache_valid_time: 3600  

- name: GITLAB=>> Upgrade all apt packages
  apt: 
    upgrade: dist 
    force_apt_get: yes    

- name: GITLAB=>> Add some packages
  apt:
    name: [ chrony, wget, curl, postfix, ca-certificates]
    state: present

# - name: Gather the rpm package facts
#   package_facts:
#     manager: auto
# - name: Check whether a package called java-1.8.0-openjdk-devel is installed
#   debug:
#     msg: "{{ ansible_facts.packages['java-1.8.0-openjdk-devel'][0].version }} versions of openjdk are installed!"
#   when: "'java-1.8.0-openjdk-devel' in ansible_facts.packages"
    
- name: GITLAB=>> populate service facts
  service_facts:
# - debug:
#     msg: "{{ ansible_facts.services }}"
- name: GITLAB=>> Run postfix service
  systemd:
    state: started
    name: "{{ item }}"
    enabled: yes
  when: item in ansible_facts.services
  with_items:
    - "postfix"
- name: GITLAB=>> Run gitlab-ce script
  shell: "curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash"
  args:
    warn: no
# - name: GITLAB=>> Make sure a some service is stoped
#   systemd:
#     state: stopped
#     name: "{{ item }}"
#     enabled: no
#   when: item in ansible_facts.services
#   with_items:
#     - "firewalld.service"
- name: "GITLAB=>> Install GitLab package "
  apt:
    name: "gitlab-ce"
    state: present
- name: GITLAB=>> Change url to gitlab.lanhome.org in file /etc/gitlab/gitlab.rb
  lineinfile:
    path: /etc/gitlab/gitlab.rb
    regexp: '{{item.From}}'
    line: '{{item.To}}'
    state: present  
  with_items:
    - { From: "^external_url 'http://gitlab.example.com'", To: "external_url 'http://gitlab.lanhome.org'"}
- name: GITLAB=>> Run configure gitlab 
  shell: "gitlab-ctl reconfigure"
  register: res_net
- name: GITLAB=>> Show ulr gitlab
  debug:
#     msg: "url address: http://{{ ansible_ssh_host }}"

- name: GITLAB=>> Cat admin password /var/lib/jenkins/secrets/initialAdminPassword
  shell: "cat /etc/gitlab/initial_root_password | grep 'Password:'"
  retries: 5
  delay: 15
  register: res_net
- name: GITLAB=>> Show root password 
  debug:
    msg: "{{ res_net.stdout }} \nurl address: http://{{ ansible_ssh_host }}"
